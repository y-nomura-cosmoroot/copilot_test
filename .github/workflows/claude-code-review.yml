name: Simple PR Review
on:
  pull_request:
    types: [opened]
jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get changed files
      id: changes
      run: |
        # PRã§å¤‰æ›´ã•ã‚ŒãŸJavaScript/TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å–å¾—
        git diff --name-only origin/${{ github.base_ref }} HEAD | grep -E '\.(js|jsx|ts|tsx)$' > changed_js_files.txt || true
        
        if [ -s changed_js_files.txt ]; then
          echo "has_js_changes=true" >> $GITHUB_OUTPUT
          echo "files=$(cat changed_js_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
        else
          echo "has_js_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Review JavaScript/TypeScript changes
      if: steps.changes.outputs.has_js_changes == 'true'
      uses: anthropics/claude-code-action@v1
      with:
        claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        prompt: |
          ã“ã®PRã®React/TypeScriptã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
          å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.changes.outputs.files }}
          ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŠé¡˜ã„ã—ã¾ã™ï¼š
          1. ãƒã‚°ã‚„æ½œåœ¨çš„ãªå•é¡Œ
          2. Reactã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
          3. TypeScriptã®å‹å®‰å…¨æ€§
          4. ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§
          ç°¡æ½”ã§å®Ÿç”¨çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
          
    - name: Post review comment
      if: steps.changes.outputs.has_js_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const changedFiles = process.env.CHANGED_FILES;
          const comment = `## ğŸ¤– AI Code Review
          
          JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚Claudeã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
          
          **ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:**
          ` + changedFiles + `
          
          è©³ç´°ãªåˆ†æçµæœã¯ä¸Šè¨˜ã®Claude Code Actionãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
          
          ---
          *è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã™ã€‚æœ€çµ‚åˆ¤æ–­ã¯äººé–“ã®ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒè¡Œã£ã¦ãã ã•ã„ã€‚*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.files }}